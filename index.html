<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTD Focus | Standalone</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { initializeFirestore, persistentLocalCache, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXutNndK5WFBmgDJKvcT3m5cOJ02WharE",
            authDomain: "gtd-focus-b2063.firebaseapp.com",
            projectId: "gtd-focus-b2063",
            storageBucket: "gtd-focus-b2063.firebasestorage.app",
            messagingSenderId: "552315500088",
            appId: "1:552315500088:web:891f9fb6c91fb9538018cd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, { localCache: persistentLocalCache() });
        const provider = new GoogleAuthProvider();

        // Expose to global scope for React (loaded via non-module script)
        window._firebase = {
            auth,
            db,
            provider,
            signInWithPopup: () => signInWithPopup(auth, provider),
            signOut: () => signOut(auth),
            onAuthStateChanged: (cb) => onAuthStateChanged(auth, cb),
            loadUserData: async (uid) => {
                const snap = await getDoc(doc(db, "users", uid));
                return snap.exists() ? snap.data() : null;
            },
            saveUserData: async (uid, data) => {
                await setDoc(doc(db, "users", uid), data);
            }
        };

        // Signal that Firebase is ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- Whisper Voice Capture Engine (lazy-loaded) -->
    <script type="module">
        window._whisper = {
            transcriber: null,
            loading: false,
            ready: false,
            error: null,

            async load(model, options = {}) {
                if (this.transcriber) return;
                this.loading = true;
                this.error = null;
                try {
                    const { pipeline } = await import('https://cdn.jsdelivr.net/npm/@huggingface/transformers@3');
                    this.transcriber = await pipeline('automatic-speech-recognition', model || 'onnx-community/whisper-base.en', {
                        dtype: options.dtype || 'q8',
                        progress_callback: options.onProgress || null
                    });
                    this.ready = true;
                } catch (err) {
                    this.error = err.message;
                    console.error('Whisper load error:', err);
                }
                this.loading = false;
            },

            async transcribe(audioBlob) {
                if (!this.transcriber) throw new Error('Whisper model not loaded');
                const url = URL.createObjectURL(audioBlob);
                try {
                    const result = await this.transcriber(url, {
                        chunk_length_s: 30,
                        stride_length_s: 5,
                        return_timestamps: false
                    });
                    return result.text.trim();
                } finally {
                    URL.revokeObjectURL(url);
                }
            },

            unload() {
                this.transcriber = null;
                this.ready = false;
                this.loading = false;
            }
        };
    </script>

    <style>
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .ai-gradient { background: linear-gradient(90deg, #4f46e5, #9333ea, #4f46e5); background-size: 200% 100%; animation: shimmer 3s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes pulse-record { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .recording-pulse { animation: pulse-record 1.5s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef, useReducer, createContext, useContext } = React;

        const defaultGeminiKey = "";

        // --- Gemini Helper ---
        async function callGemini(apiKey, prompt, systemPrompt = "") {
            if (!apiKey) return null;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return text ? JSON.parse(text) : null;
            } catch (error) {
                console.error("Gemini Error:", error);
                alert("AI Error: Check your API Key or Internet Connection.");
                return null;
            }
        }

        // --- Shared Utilities ---
        function generateId() {
            return typeof crypto !== 'undefined' && crypto.randomUUID
                ? crypto.randomUUID()
                : Date.now().toString(36) + Math.random().toString(36).slice(2);
        }

        function formatTaskDate(dateStr) {
            if (!dateStr) return null;
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date(); today.setHours(0,0,0,0);
            const diffDays = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
            let colorClass = 'text-gray-400', text = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            if (diffDays < 0) { colorClass = 'text-red-600 font-bold'; text = `Overdue (${text})`; } else if (diffDays === 0) { colorClass = 'text-orange-600 font-bold'; text = 'Today'; } else if (diffDays === 1) { colorClass = 'text-blue-600'; text = 'Tomorrow'; }
            return { text, colorClass };
        }

        const IS_MOBILE = /iPhone|iPad|Android/i.test(navigator.userAgent);

        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, info) { console.error('React ErrorBoundary caught:', error, info); }
            render() {
                if (this.state.hasError) {
                    return React.createElement('div', { className: 'min-h-screen flex items-center justify-center bg-gray-50' },
                        React.createElement('div', { className: 'text-center p-8 max-w-md' },
                            React.createElement('h2', { className: 'text-xl font-bold text-gray-800 mb-2' }, 'Something went wrong'),
                            React.createElement('p', { className: 'text-gray-500 mb-4' }, 'The app encountered an unexpected error.'),
                            React.createElement('button', {
                                className: 'px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700',
                                onClick: () => { this.setState({ hasError: false, error: null }); }
                            }, 'Try Again')
                        )
                    );
                }
                return this.props.children;
            }
        }

        // --- Firebase Context (Dependency Injection) ---
        const FirebaseContext = createContext(null);

        function FirebaseProvider({ children }) {
            const [firebase, setFirebase] = useState(window._firebase || null);

            useEffect(() => {
                if (firebase) return;
                const handler = () => setFirebase(window._firebase);
                window.addEventListener('firebase-ready', handler);
                return () => window.removeEventListener('firebase-ready', handler);
            }, [firebase]);

            return <FirebaseContext.Provider value={firebase}>{children}</FirebaseContext.Provider>;
        }

        function useFirebase() {
            return useContext(FirebaseContext);
        }

        // --- Icons ---
        const Icons = {
            Inbox: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" /></svg>,
            Next: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
            Waiting: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Project: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>,
            Someday: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 21v-8a2 2 0 012-2h14a2 2 0 012 2v8M3 13l6 6m0 0l6-6m-6 6V3" /></svg>,
            Calendar: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            Trash: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
            Plus: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Reference: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
            Done: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Sparkles: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
            Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
            Review: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            Save: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
            Google: () => <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            BrainDump: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>,
            Dashboard: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>,
            AlertCircle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            TrendingUp: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
            Guide: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            ChevronDown: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
            ChevronUp: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>,
            Send: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
            Microphone: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4M12 15a3 3 0 003-3V5a3 3 0 00-6 0v7a3 3 0 003 3z" /></svg>,
            Stop: () => <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2" /></svg>
        };

        // --- Data Reducer ---
        const dataInitialState = {
            tasks: [],
            contexts: ['@work', '@home', '@computer', '@calls', '@errands'],
            delegates: [],
            apiKey: defaultGeminiKey,
            loaded: false,
            saveStatus: 'saved', // 'saved' | 'unsaved' | 'saving' | 'error'
        };

        function dataReducer(state, action) {
            switch (action.type) {
                case 'RESET':
                    return { ...dataInitialState, saveStatus: 'saved' };
                case 'LOAD_DATA': {
                    const d = action.payload;
                    return {
                        ...state,
                        tasks: d.tasks || state.tasks,
                        contexts: d.contexts || state.contexts,
                        delegates: d.delegates || state.delegates,
                        apiKey: d.geminiApiKey || state.apiKey,
                        loaded: true,
                        saveStatus: 'saved',
                    };
                }
                case 'LOAD_FAILED':
                    return { ...state, loaded: true };
                case 'SET_TASKS': {
                    const next = typeof action.payload === 'function' ? action.payload(state.tasks) : action.payload;
                    return { ...state, tasks: next, saveStatus: 'unsaved' };
                }
                case 'SET_CONTEXTS': {
                    const next = typeof action.payload === 'function' ? action.payload(state.contexts) : action.payload;
                    return { ...state, contexts: next, saveStatus: 'unsaved' };
                }
                case 'SET_DELEGATES': {
                    const next = typeof action.payload === 'function' ? action.payload(state.delegates) : action.payload;
                    return { ...state, delegates: next, saveStatus: 'unsaved' };
                }
                case 'SET_API_KEY': {
                    const next = typeof action.payload === 'function' ? action.payload(state.apiKey) : action.payload;
                    return { ...state, apiKey: next, saveStatus: 'unsaved' };
                }
                case 'SAVE_START':
                    return { ...state, saveStatus: 'saving' };
                case 'SAVE_SUCCESS':
                    // Only mark 'saved' if still 'saving' — don't overwrite 'unsaved' from new changes
                    return state.saveStatus === 'saving' ? { ...state, saveStatus: 'saved' } : state;
                case 'SAVE_ERROR':
                    return state.saveStatus === 'saving' ? { ...state, saveStatus: 'error' } : state;
                default:
                    return state;
            }
        }

        // --- Save with Exponential Backoff ---
        async function saveWithRetry(firebase, uid, data, maxRetries = 3) {
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    await firebase.saveUserData(uid, data);
                    return true;
                } catch (err) {
                    console.error(`Save attempt ${attempt + 1}/${maxRetries + 1} failed:`, err);
                    if (attempt < maxRetries) {
                        await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000));
                    }
                }
            }
            return false;
        }

        // --- Firebase Data Hook ---
        function useFirebaseData(user) {
            const firebase = useFirebase();
            const [state, dispatch] = useReducer(dataReducer, dataInitialState);
            const saveTimeoutRef = useRef(null);
            const stateRef = useRef(state);
            stateRef.current = state;

            // Load data from Firestore when user logs in
            useEffect(() => {
                if (!user || !firebase) return;
                dispatch({ type: 'RESET' });
                firebase.loadUserData(user.uid).then(data => {
                    dispatch({ type: 'LOAD_DATA', payload: data || {} });
                }).catch(err => {
                    console.error("Load error:", err);
                    dispatch({ type: 'LOAD_FAILED' });
                });
            }, [user, firebase]);

            // Auto-save effect: React guarantees this runs when data changes
            useEffect(() => {
                if (!user || !firebase || !state.loaded || state.saveStatus !== 'unsaved') return;

                const data = { tasks: state.tasks, contexts: state.contexts, delegates: state.delegates, geminiApiKey: state.apiKey };

                const timeout = setTimeout(async () => {
                    saveTimeoutRef.current = null;
                    dispatch({ type: 'SAVE_START' });
                    const success = await saveWithRetry(firebase, user.uid, data);
                    // Only update status if still 'saving' (no new changes arrived during save)
                    if (stateRef.current.saveStatus === 'saving') {
                        dispatch({ type: success ? 'SAVE_SUCCESS' : 'SAVE_ERROR' });
                    }
                }, 500);
                saveTimeoutRef.current = timeout;

                return () => { clearTimeout(timeout); saveTimeoutRef.current = null; };
            }, [user, firebase, state.loaded, state.saveStatus, state.tasks, state.contexts, state.delegates, state.apiKey]);

            // Flush pending save on page hide / tab close
            const flushSave = useCallback(() => {
                if (saveTimeoutRef.current) { clearTimeout(saveTimeoutRef.current); saveTimeoutRef.current = null; }
                const s = stateRef.current;
                if (!user || !firebase || !s.loaded || s.saveStatus === 'saved') return;
                const data = { tasks: s.tasks, contexts: s.contexts, delegates: s.delegates, geminiApiKey: s.apiKey };
                firebase.saveUserData(user.uid, data).catch(err => console.error("Flush save error:", err));
            }, [user, firebase]);

            useEffect(() => {
                window.addEventListener('pagehide', flushSave);
                window.addEventListener('beforeunload', flushSave);
                return () => {
                    window.removeEventListener('pagehide', flushSave);
                    window.removeEventListener('beforeunload', flushSave);
                    flushSave();
                };
            }, [flushSave]);

            // Stable setters — dispatch only, save is driven by the effect above
            const setTasks = useCallback((value) => { dispatch({ type: 'SET_TASKS', payload: value }); }, []);
            const setContexts = useCallback((value) => { dispatch({ type: 'SET_CONTEXTS', payload: value }); }, []);
            const setDelegates = useCallback((value) => { dispatch({ type: 'SET_DELEGATES', payload: value }); }, []);
            const setApiKey = useCallback((value) => { dispatch({ type: 'SET_API_KEY', payload: value }); }, []);

            return {
                tasks: state.tasks, setTasks,
                contexts: state.contexts, setContexts,
                delegates: state.delegates, setDelegates,
                apiKey: state.apiKey, setApiKey,
                loaded: state.loaded, saveStatus: state.saveStatus,
            };
        }

        // --- Voice Capture Hook ---
        function useVoiceCapture() {
            const [voiceState, setVoiceState] = useState('idle');
            const [transcript, setTranscript] = useState('');
            const [loadProgress, setLoadProgress] = useState(0);
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);
            const recognitionRef = useRef(null);
            const isMobile = IS_MOBILE;

            const startRecording = useCallback(async () => {
                setTranscript('');
                if (isMobile) {
                    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (!SR) { alert('Speech recognition is not supported in this browser.'); return; }
                    const recognition = new SR();
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'en-US';
                    let finalTranscript = '';
                    recognition.onresult = (event) => {
                        let interim = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + ' ';
                            else interim += event.results[i][0].transcript;
                        }
                        setTranscript(finalTranscript + interim);
                    };
                    recognition.onerror = () => setVoiceState('idle');
                    recognition.onend = () => setVoiceState('idle');
                    recognitionRef.current = recognition;
                    recognition.start();
                    setVoiceState('recording');
                } else {
                    if (!window._whisper) {
                        alert('Voice engine is still loading. Please try again in a moment.');
                        return;
                    }
                    if (!window._whisper.ready) {
                        setVoiceState('loading');
                        setLoadProgress(0);
                        const model = localStorage.getItem('whisperModel') || 'onnx-community/whisper-base.en';
                        await window._whisper.load(model, {
                            dtype: 'q8',
                            onProgress: (p) => { if (p.progress) setLoadProgress(Math.round(p.progress)); }
                        });
                        if (window._whisper.error) {
                            alert('Failed to load voice model: ' + window._whisper.error);
                            setVoiceState('idle');
                            return;
                        }
                    }
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const mediaRecorder = new MediaRecorder(stream);
                        audioChunksRef.current = [];
                        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunksRef.current.push(e.data); };
                        mediaRecorder.onstop = async () => {
                            stream.getTracks().forEach(t => t.stop());
                            setVoiceState('transcribing');
                            try {
                                const audioBlob = new Blob(audioChunksRef.current, { type: mediaRecorder.mimeType });
                                const text = await window._whisper.transcribe(audioBlob);
                                setTranscript(text);
                            } catch (err) {
                                console.error('Transcription error:', err);
                            }
                            setVoiceState('idle');
                        };
                        mediaRecorderRef.current = mediaRecorder;
                        mediaRecorder.start();
                        setVoiceState('recording');
                    } catch (err) {
                        console.error('Mic access error:', err);
                        alert('Microphone access denied. Please allow microphone access and try again.');
                        setVoiceState('idle');
                    }
                }
            }, [isMobile]);

            const stopRecording = useCallback(() => {
                if (isMobile && recognitionRef.current) recognitionRef.current.stop();
                else if (mediaRecorderRef.current?.state === 'recording') mediaRecorderRef.current.stop();
            }, [isMobile]);

            return { voiceState, transcript, setTranscript, startRecording, stopRecording, isMobile, loadProgress };
        }

        // --- Shared Components ---
        const TaskItem = React.memo(({ task, onCheck, onClick }) => {
            const getContextColor = (ctx) => { switch(ctx) { case '@work': return 'bg-purple-100 text-purple-800'; case '@home': return 'bg-green-100 text-green-800'; case '@calls': return 'bg-yellow-100 text-yellow-800'; default: return 'bg-gray-100 text-gray-600'; } };
            const dateInfo = formatTaskDate(task.dueDate);
            return (
                <div onClick={() => onClick(task)} className="group bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-all cursor-pointer flex items-center justify-between">
                    <div className="flex items-center flex-1">
                        <button onClick={(e) => { e.stopPropagation(); onCheck(task.id); }} className={`w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center transition-colors ${task.status === 'done' ? 'bg-green-500 border-green-500' : 'border-gray-300 hover:border-blue-500'}`}>
                            {task.status === 'done' && <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>}
                        </button>
                        <div className={`${task.status === 'done' ? 'line-through text-gray-400' : 'text-gray-800'} w-full`}>
                            <div className="font-medium">{task.text}</div>
                            <div className="flex items-center gap-2 mt-1 text-xs flex-wrap">
                                {task.project && <span className="text-blue-600 font-medium flex items-center"><Icons.Project /> <span className="ml-1">{task.project}</span></span>}
                                {task.context && <span className={`px-1.5 rounded ${getContextColor(task.context)}`}>{task.context}</span>}
                                {task.owner && <span className="bg-purple-100 text-purple-800 px-1.5 rounded flex items-center"><Icons.User /> <span className="ml-1">{task.owner}</span></span>}
                                {dateInfo && <span className={`flex items-center ${dateInfo.colorClass}`}>{dateInfo.text}</span>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        });

        const SidebarItem = ({ active, label, count, icon: Icon, onClick }) => (
            <button onClick={onClick} className={`w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-colors ${active ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'}`}>
                <div className="flex items-center"><Icon /><span className="ml-3">{label}</span></div>
                {count > 0 && <span className={`${active ? 'bg-blue-200 text-blue-800' : 'bg-gray-200 text-gray-600'} py-0.5 px-2 rounded-full text-xs`}>{count}</span>}
            </button>
        );

        // --- Login Screen ---
        const LoginScreen = ({ onLogin, loading }) => {
            const [currentSlide, setCurrentSlide] = useState(0);

            const features = [
                {
                    icon: <Icons.Inbox />,
                    title: "Capture Everything",
                    description: "Get it out of your head and into a trusted system. Never lose a thought again.",
                    color: "from-blue-500 to-cyan-500"
                },
                {
                    icon: <Icons.BrainDump />,
                    title: "AI-Powered Processing",
                    description: "Brain dump your thoughts and let AI organize them into actionable tasks instantly.",
                    color: "from-purple-500 to-pink-500"
                },
                {
                    icon: <Icons.Project />,
                    title: "Project Clarity",
                    description: "See all your projects at a glance with progress tracking and next actions.",
                    color: "from-orange-500 to-red-500"
                },
                {
                    icon: <Icons.Calendar />,
                    title: "Never Miss a Deadline",
                    description: "Calendar view keeps you focused on what's due today, tomorrow, and beyond.",
                    color: "from-green-500 to-emerald-500"
                }
            ];

            const values = [
                { stat: "100%", label: "Cloud Synced", sublabel: "Access anywhere" },
                { stat: "0", label: "Mental Load", sublabel: "Trust the system" },
                { stat: "5x", label: "More Focused", sublabel: "Clear priorities" }
            ];

            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentSlide((prev) => (prev + 1) % features.length);
                }, 4000);
                return () => clearInterval(timer);
            }, []);

            return (
                <div className="min-h-screen bg-gray-900 text-white overflow-x-hidden">
                    {/* Hero Section */}
                    <div className="relative min-h-screen flex flex-col">
                        {/* Animated Background */}
                        <div className="absolute inset-0 overflow-hidden">
                            <div className="absolute -top-40 -right-40 w-80 h-80 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
                            <div className="absolute top-40 -left-40 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style={{animationDelay: '1s'}}></div>
                            <div className="absolute bottom-40 right-20 w-80 h-80 bg-cyan-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style={{animationDelay: '2s'}}></div>
                        </div>

                        {/* Navigation */}
                        <nav className="relative z-10 flex items-center justify-between px-6 lg:px-12 py-6">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-sm font-bold shadow-lg shadow-blue-500/25">GTD</div>
                                <span className="text-xl font-bold">Focus</span>
                            </div>
                            <button onClick={onLogin} disabled={loading} className="flex items-center gap-2 px-5 py-2.5 bg-white/10 backdrop-blur-sm border border-white/20 rounded-full hover:bg-white/20 transition-all text-sm font-medium">
                                {loading ? <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full spinner"></span> : <Icons.Google />}
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </nav>

                        {/* Hero Content */}
                        <div className="relative z-10 flex-1 flex flex-col items-center justify-center px-6 text-center -mt-16">
                            <h1 className="text-5xl lg:text-7xl font-bold mb-6 leading-tight">
                                Clear Mind.<br />
                                Sharp Focus.<br />
                                <span className="bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">Brilliant Execution.</span>
                            </h1>

                            <p className="text-xl text-gray-400 max-w-2xl mb-10 leading-relaxed">
                                Stop juggling tasks in your head. GTD Focus captures, organizes, and prioritizes everything — so you can focus on what truly matters.
                            </p>

                            <button onClick={onLogin} disabled={loading} className="group flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full text-lg font-semibold shadow-xl shadow-purple-500/25 hover:shadow-purple-500/40 hover:scale-105 transition-all disabled:opacity-50">
                                {loading ? (
                                    <><span className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full spinner"></span> Signing in...</>
                                ) : (
                                    <>
                                        <Icons.Google />
                                        Get Started Free
                                        <svg className="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                                    </>
                                )}
                            </button>
                        </div>

                        {/* Scroll Indicator */}
                        <div className="relative z-10 flex justify-center pb-8">
                            <div className="w-6 h-10 border-2 border-white/20 rounded-full flex justify-center pt-2">
                                <div className="w-1.5 h-3 bg-white/40 rounded-full animate-bounce"></div>
                            </div>
                        </div>
                    </div>

                    {/* Stats Section */}
                    <div className="relative bg-gradient-to-b from-gray-900 to-gray-800 py-16">
                        <div className="max-w-5xl mx-auto px-6">
                            <div className="grid grid-cols-3 gap-8">
                                {values.map((item, i) => (
                                    <div key={i} className="text-center">
                                        <div className="text-4xl lg:text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">{item.stat}</div>
                                        <div className="text-lg font-medium text-white mt-2">{item.label}</div>
                                        <div className="text-sm text-gray-500">{item.sublabel}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Features Carousel */}
                    <div className="relative bg-gray-800 py-20 overflow-hidden">
                        <div className="max-w-6xl mx-auto px-6">
                            <div className="text-center mb-16">
                                <h2 className="text-3xl lg:text-4xl font-bold mb-4">Everything You Need to <span className="bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Get Things Done</span></h2>
                                <p className="text-gray-400 text-lg max-w-2xl mx-auto">A complete GTD system designed to capture your thoughts, clarify actions, and keep you focused on what matters.</p>
                            </div>

                            {/* Feature Cards */}
                            <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                                {features.map((feature, i) => (
                                    <div key={i} className={`group relative bg-gray-900/50 backdrop-blur-sm border border-gray-700/50 rounded-2xl p-6 hover:border-gray-600 transition-all hover:-translate-y-1 ${currentSlide === i ? 'ring-2 ring-purple-500/50 border-purple-500/50' : ''}`}>
                                        <div className={`w-12 h-12 bg-gradient-to-br ${feature.color} rounded-xl flex items-center justify-center text-white mb-4 shadow-lg group-hover:scale-110 transition-transform`}>
                                            {feature.icon}
                                        </div>
                                        <h3 className="text-xl font-semibold mb-2">{feature.title}</h3>
                                        <p className="text-gray-400 text-sm leading-relaxed">{feature.description}</p>
                                    </div>
                                ))}
                            </div>

                            {/* Carousel Dots */}
                            <div className="flex justify-center gap-2 mt-8">
                                {features.map((_, i) => (
                                    <button key={i} onClick={() => setCurrentSlide(i)} className={`w-2 h-2 rounded-full transition-all ${currentSlide === i ? 'bg-purple-500 w-6' : 'bg-gray-600 hover:bg-gray-500'}`} />
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Value Proposition Section */}
                    <div className="relative bg-gradient-to-b from-gray-800 to-gray-900 py-20">
                        <div className="max-w-5xl mx-auto px-6">
                            <div className="grid lg:grid-cols-2 gap-12 items-center">
                                <div>
                                    <h2 className="text-3xl lg:text-4xl font-bold mb-6">
                                        Your Brain is for <span className="bg-gradient-to-r from-orange-400 to-pink-400 bg-clip-text text-transparent">Having Ideas</span>, Not Holding Them
                                    </h2>
                                    <p className="text-gray-400 text-lg mb-8 leading-relaxed">
                                        David Allen's Getting Things Done methodology has helped millions achieve stress-free productivity. GTD Focus brings this proven system to life with modern tools and AI assistance.
                                    </p>
                                    <ul className="space-y-4">
                                        {[
                                            "Capture thoughts instantly before they slip away",
                                            "Process inbox items with AI-powered clarity",
                                            "Review projects and commitments weekly",
                                            "Focus on the right task at the right time"
                                        ].map((item, i) => (
                                            <li key={i} className="flex items-start gap-3">
                                                <div className="w-6 h-6 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                                    <svg className="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>
                                                </div>
                                                <span className="text-gray-300">{item}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                                <div className="relative">
                                    <div className="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl blur-2xl opacity-20"></div>
                                    <div className="relative bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-2xl">
                                        <div className="flex items-center gap-2 mb-4">
                                            <div className="w-3 h-3 bg-red-500 rounded-full"></div>
                                            <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                            <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                                        </div>
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-3 p-3 bg-gray-900/50 rounded-lg">
                                                <div className="w-5 h-5 rounded-full border-2 border-blue-500"></div>
                                                <span className="text-gray-300">Review Q4 budget proposal</span>
                                                <span className="ml-auto text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">@work</span>
                                            </div>
                                            <div className="flex items-center gap-3 p-3 bg-gray-900/50 rounded-lg">
                                                <div className="w-5 h-5 rounded-full border-2 border-green-500 flex items-center justify-center">
                                                    <svg className="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                                                </div>
                                                <span className="text-gray-500 line-through">Schedule dentist appointment</span>
                                            </div>
                                            <div className="flex items-center gap-3 p-3 bg-gray-900/50 rounded-lg">
                                                <div className="w-5 h-5 rounded-full border-2 border-orange-500"></div>
                                                <span className="text-gray-300">Call mom for birthday</span>
                                                <span className="ml-auto text-xs bg-orange-500/20 text-orange-400 px-2 py-1 rounded">Today</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* CTA Section */}
                    <div className="relative bg-gray-900 py-20">
                        <div className="absolute inset-0 overflow-hidden">
                            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-to-r from-blue-500 to-purple-600 rounded-full blur-3xl opacity-10"></div>
                        </div>
                        <div className="relative max-w-3xl mx-auto px-6 text-center">
                            <h2 className="text-3xl lg:text-4xl font-bold mb-6">Ready to Achieve <span className="bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Stress-Free Productivity</span>?</h2>
                            <p className="text-gray-400 text-lg mb-8">Join thousands who have transformed their productivity with GTD Focus.</p>
                            <button onClick={onLogin} disabled={loading} className="group inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full text-lg font-semibold shadow-xl shadow-purple-500/25 hover:shadow-purple-500/40 hover:scale-105 transition-all disabled:opacity-50">
                                {loading ? (
                                    <><span className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full spinner"></span> Signing in...</>
                                ) : (
                                    <>
                                        <Icons.Google />
                                        Start Getting Things Done
                                        <svg className="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>

                    {/* Footer */}
                    <footer className="bg-gray-900 border-t border-gray-800 py-8">
                        <div className="max-w-5xl mx-auto px-6 flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-2 text-gray-400">
                                <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-xs font-bold text-white">GTD</div>
                                <span className="font-medium">Focus</span>
                            </div>
                            <p className="text-sm text-gray-500 flex items-center gap-2">
                                <span className="w-1.5 h-1.5 bg-green-400 rounded-full"></span>
                                Inspired by David Allen's GTD Methodology
                            </p>
                        </div>
                    </footer>
                </div>
            );
        };

        // --- Views ---
        const WeeklyReview = ({ tasks, onCheck, onClick }) => {
            const activeProjects = [...new Set(tasks.filter(t => t.project && t.status !== 'done' && t.status !== 'trash').map(t => t.project))];
            const nextActions = tasks.filter(t => t.status === 'next');
            const waitingFor = tasks.filter(t => t.status === 'waiting');
            const inboxCount = tasks.filter(t => t.status === 'inbox').length;
            return (
                <div className="space-y-8 pb-20 max-w-3xl mx-auto">
                    <div className="bg-indigo-50 p-6 rounded-xl border border-indigo-100 flex justify-between items-center">
                        <div><h3 className="text-xl font-bold text-indigo-900 mb-1 flex items-center gap-2"><Icons.Review /> Weekly Review</h3><p className="text-sm text-indigo-700">Empty your head. Get clear. Get current.</p></div>
                        <div className="text-center bg-white p-3 rounded-lg shadow-sm"><div className={`text-2xl font-bold ${inboxCount > 0 ? 'text-red-500' : 'text-green-500'}`}>{inboxCount}</div><div className="text-xs text-gray-500 uppercase">Inbox</div></div>
                    </div>
                    <div>
                        <h4 className="text-lg font-bold text-gray-800 mb-3 border-b pb-2">Active Projects ({activeProjects.length})</h4>
                        {activeProjects.length === 0 ? <p className="text-gray-400 italic">No active projects.</p> : <div className="space-y-4">{activeProjects.map(proj => ( <div key={proj} className="bg-white border border-gray-200 rounded-lg p-4"><div className="font-bold text-gray-800 mb-2 flex items-center gap-2"><Icons.Project /> {proj}</div><div className="space-y-2 pl-2 border-l-2 border-gray-100 ml-1">{tasks.filter(t => t.project === proj && t.status !== 'done' && t.status !== 'trash').map(task => (<TaskItem key={task.id} task={task} onCheck={onCheck} onClick={onClick} />))}</div></div>))}</div>}
                    </div>
                    <div>
                        <h4 className="text-lg font-bold text-gray-800 mb-3 border-b pb-2">Waiting For ({waitingFor.length})</h4>
                        <div className="space-y-2">{waitingFor.length === 0 ? <p className="text-gray-400 italic">Nothing waiting.</p> : waitingFor.map(task => (<TaskItem key={task.id} task={task} onCheck={onCheck} onClick={onClick} />))}</div>
                    </div>
                    <div>
                        <h4 className="text-lg font-bold text-gray-800 mb-3 border-b pb-2">Next Actions ({nextActions.length})</h4>
                        <div className="space-y-2">{nextActions.length === 0 ? <p className="text-gray-400 italic">No next actions.</p> : nextActions.map(task => (<TaskItem key={task.id} task={task} onCheck={onCheck} onClick={onClick} />))}</div>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ contexts, setContexts, delegates, setDelegates, apiKey, setApiKey, user, onLogout }) => {
            const [newContext, setNewContext] = useState('');
            const [newDelegate, setNewDelegate] = useState('');
            const [whisperModel, setWhisperModel] = useState(localStorage.getItem('whisperModel') || 'onnx-community/whisper-base.en');
            const settingsIsMobile = IS_MOBILE;

            const addContext = (e) => { e.preventDefault(); if (newContext && !contexts.includes(newContext)) { setContexts([...contexts, newContext.startsWith('@') ? newContext : '@' + newContext]); setNewContext(''); } };
            const removeContext = (ctx) => setContexts(contexts.filter(c => c !== ctx));
            const addDelegate = (e) => { e.preventDefault(); if (newDelegate && !delegates.includes(newDelegate)) { setDelegates([...delegates, newDelegate]); setNewDelegate(''); } };
            const removeDelegate = (d) => setDelegates(delegates.filter(x => x !== d));

            return (
                <div className="max-w-2xl mx-auto space-y-8">
                    {/* Account */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><Icons.User /> <span className="ml-2">Account</span></h3>
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                {user.photoURL && <img src={user.photoURL} alt="" className="w-10 h-10 rounded-full" referrerPolicy="no-referrer" />}
                                <div>
                                    <div className="font-medium text-gray-800">{user.displayName}</div>
                                    <div className="text-sm text-gray-500">{user.email}</div>
                                </div>
                            </div>
                            <button onClick={onLogout} className="flex items-center gap-2 px-4 py-2 text-sm text-red-600 border border-red-200 rounded-lg hover:bg-red-50">
                                <Icons.Logout /> Sign Out
                            </button>
                        </div>
                        <p className="text-xs text-green-600 mt-3">Data syncs automatically to the cloud.</p>
                    </div>

                    {/* API Key */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                         <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center"><Icons.Sparkles /> <span className="ml-2">AI Settings</span></h3>
                         <p className="text-sm text-gray-500 mb-3">To use Smart Clarify, enter your Gemini API Key.</p>
                         <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Paste Gemini API Key..." className="w-full p-2 border rounded" />
                    </div>

                    {/* Voice Capture */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center"><Icons.Microphone /> <span className="ml-2">Voice Capture</span></h3>
                        <p className="text-sm text-gray-500 mb-3">
                            {settingsIsMobile
                                ? 'Uses your browser\'s built-in speech recognition on mobile devices.'
                                : 'Uses OpenAI Whisper running locally in your browser. The model downloads once and is cached.'}
                        </p>
                        {!settingsIsMobile && (
                            <>
                                <label className="block text-xs text-gray-500 font-bold uppercase mb-1">Whisper Model</label>
                                <select
                                    value={whisperModel}
                                    onChange={(e) => {
                                        setWhisperModel(e.target.value);
                                        localStorage.setItem('whisperModel', e.target.value);
                                        if (window._whisper?.ready) window._whisper.unload();
                                    }}
                                    className="w-full p-2 border rounded text-sm mb-3"
                                >
                                    <option value="onnx-community/whisper-tiny.en">Tiny (~40 MB) — fastest, lower accuracy</option>
                                    <option value="onnx-community/whisper-base.en">Base (~75 MB) — balanced (recommended)</option>
                                    <option value="onnx-community/whisper-small.en">Small (~180 MB) — best accuracy, slower</option>
                                </select>
                                <div className="flex items-center gap-2 text-xs text-gray-400">
                                    <span className={`w-2 h-2 rounded-full ${window._whisper?.ready ? 'bg-green-500' : 'bg-gray-300'}`}></span>
                                    {window._whisper?.ready ? 'Model loaded & cached' : 'Model downloads on first use of voice capture'}
                                </div>
                            </>
                        )}
                    </div>

                    {/* Contexts */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><Icons.Settings /> <span className="ml-2">Contexts</span></h3>
                        <form onSubmit={addContext} className="flex gap-2 mb-4"><input type="text" value={newContext} onChange={e => setNewContext(e.target.value)} placeholder="Add context..." className="flex-1 p-2 border rounded text-sm" /><button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded text-sm">Add</button></form>
                        <div className="flex flex-wrap gap-2">{contexts.map(ctx => (<span key={ctx} className="px-3 py-1 bg-gray-100 rounded-full text-sm text-gray-700 flex items-center border">{ctx} <button onClick={() => removeContext(ctx)} className="ml-2 text-gray-400 hover:text-red-500">&times;</button></span>))}</div>
                    </div>

                    {/* Delegates */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center"><Icons.User /> <span className="ml-2">Delegates</span></h3>
                        <form onSubmit={addDelegate} className="flex gap-2 mb-4"><input type="text" value={newDelegate} onChange={e => setNewDelegate(e.target.value)} placeholder="Add person..." className="flex-1 p-2 border rounded text-sm" /><button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded text-sm">Add</button></form>
                        <div className="flex flex-wrap gap-2">{delegates.map(d => (<span key={d} className="px-3 py-1 bg-purple-50 rounded-full text-sm text-purple-700 flex items-center border border-purple-100">{d} <button onClick={() => removeDelegate(d)} className="ml-2 text-purple-400 hover:text-red-500">&times;</button></span>))}</div>
                    </div>
                </div>
            );
        };

        const CalendarView = ({ tasks, onCheck, onClick }) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const tasksWithDates = tasks.filter(t => t.dueDate && t.status !== 'done' && t.status !== 'trash');

            const categorize = (task) => {
                const dueDate = new Date(task.dueDate + 'T00:00:00');
                const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                if (diffDays < 0) return 'overdue';
                if (diffDays === 0) return 'today';
                if (diffDays === 1) return 'tomorrow';
                if (diffDays <= 7) return 'thisWeek';
                return 'later';
            };

            const grouped = { overdue: [], today: [], tomorrow: [], thisWeek: [], later: [] };
            tasksWithDates.forEach(task => { grouped[categorize(task)].push(task); });

            // Sort each group by date
            const sortByDate = (a, b) => new Date(a.dueDate) - new Date(b.dueDate);
            Object.keys(grouped).forEach(key => grouped[key].sort(sortByDate));

            const Section = ({ title, tasks, color, bgColor, icon }) => {
                if (tasks.length === 0) return null;
                return (
                    <div className="mb-6">
                        <div className={`flex items-center gap-2 mb-3 pb-2 border-b ${color}`}>
                            {icon}
                            <h4 className="text-lg font-bold">{title}</h4>
                            <span className={`ml-2 px-2 py-0.5 rounded-full text-xs font-medium ${bgColor}`}>{tasks.length}</span>
                        </div>
                        <div className="space-y-2">
                            {tasks.map(task => <TaskItem key={task.id} task={task} onCheck={onCheck} onClick={onClick} />)}
                        </div>
                    </div>
                );
            };

            const formatDateHeader = (dateStr) => {
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
            };

            return (
                <div className="max-w-3xl mx-auto pb-20">
                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-100 mb-8">
                        <div className="flex items-center justify-between">
                            <div>
                                <h3 className="text-xl font-bold text-blue-900 mb-1 flex items-center gap-2">
                                    <Icons.Calendar /> Calendar
                                </h3>
                                <p className="text-sm text-blue-700">Tasks with due dates</p>
                            </div>
                            <div className="text-center bg-white p-3 rounded-lg shadow-sm">
                                <div className={`text-2xl font-bold ${grouped.overdue.length > 0 ? 'text-red-500' : 'text-green-500'}`}>
                                    {grouped.overdue.length}
                                </div>
                                <div className="text-xs text-gray-500 uppercase">Overdue</div>
                            </div>
                        </div>
                    </div>

                    {tasksWithDates.length === 0 ? (
                        <div className="text-center text-gray-400 mt-20 flex flex-col items-center">
                            <div className="opacity-20 mb-4 scale-150"><Icons.Calendar /></div>
                            <p>No tasks with due dates</p>
                            <p className="text-sm mt-1">Add a due date to a task to see it here</p>
                        </div>
                    ) : (
                        <>
                            <Section
                                title="Overdue"
                                tasks={grouped.overdue}
                                color="text-red-700"
                                bgColor="bg-red-100 text-red-700"
                                icon={<svg className="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>}
                            />
                            <Section
                                title="Today"
                                tasks={grouped.today}
                                color="text-orange-700"
                                bgColor="bg-orange-100 text-orange-700"
                                icon={<svg className="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>}
                            />
                            <Section
                                title="Tomorrow"
                                tasks={grouped.tomorrow}
                                color="text-blue-700"
                                bgColor="bg-blue-100 text-blue-700"
                                icon={<svg className="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>}
                            />
                            <Section
                                title="This Week"
                                tasks={grouped.thisWeek}
                                color="text-indigo-700"
                                bgColor="bg-indigo-100 text-indigo-700"
                                icon={<svg className="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>}
                            />
                            <Section
                                title="Later"
                                tasks={grouped.later}
                                color="text-gray-600"
                                bgColor="bg-gray-100 text-gray-600"
                                icon={<svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>}
                            />
                        </>
                    )}
                </div>
            );
        };

        const DashboardView = ({ tasks, onCheck, onClick, setView }) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Calculate stats
            const inbox = tasks.filter(t => t.status === 'inbox');
            const nextActions = tasks.filter(t => t.status === 'next');
            const waitingFor = tasks.filter(t => t.status === 'waiting');
            const someday = tasks.filter(t => t.status === 'someday');
            const activeTasks = tasks.filter(t => t.status !== 'done' && t.status !== 'trash');

            // Completed this week
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            const completedThisWeek = tasks.filter(t => {
                if (t.status !== 'done') return false;
                const doneDate = t.completedAt ? new Date(t.completedAt) : new Date(t.created);
                return doneDate >= weekAgo;
            });

            // Projects with progress
            const projectNames = [...new Set(tasks.filter(t => t.project).map(t => t.project))];
            const projectStats = projectNames.map(name => {
                const projectTasks = tasks.filter(t => t.project === name);
                const total = projectTasks.length;
                const done = projectTasks.filter(t => t.status === 'done').length;
                const active = projectTasks.filter(t => t.status !== 'done' && t.status !== 'trash');
                const hasOverdue = active.some(t => {
                    if (!t.dueDate) return false;
                    const due = new Date(t.dueDate + 'T00:00:00');
                    return due < today;
                });
                const nextDue = active
                    .filter(t => t.dueDate)
                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))[0]?.dueDate;
                return { name, total, done, progress: total > 0 ? Math.round((done / total) * 100) : 0, hasOverdue, nextDue, activeCount: active.length };
            }).filter(p => p.activeCount > 0).sort((a, b) => b.activeCount - a.activeCount);

            // Focus Today: overdue + due today
            const focusTasks = activeTasks.filter(t => {
                if (!t.dueDate) return false;
                const due = new Date(t.dueDate + 'T00:00:00');
                return due <= today;
            }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

            const overdueCount = activeTasks.filter(t => {
                if (!t.dueDate) return false;
                const due = new Date(t.dueDate + 'T00:00:00');
                return due < today;
            }).length;

            const StatCard = ({ label, value, icon: Icon, color, bgColor, onClick }) => (
                <button onClick={onClick} className={`${bgColor} p-4 rounded-xl border transition-all hover:shadow-md text-left w-full`}>
                    <div className="flex items-center justify-between mb-2">
                        <span className={`${color}`}><Icon /></span>
                    </div>
                    <div className={`text-3xl font-bold ${color}`}>{value}</div>
                    <div className="text-sm text-gray-500 mt-1">{label}</div>
                </button>
            );

            const formatDate = (dateStr) => {
                const info = formatTaskDate(dateStr);
                return info ? info.text : '';
            };

            const getProgressColor = (progress) => {
                if (progress >= 75) return 'bg-green-500';
                if (progress >= 50) return 'bg-blue-500';
                if (progress >= 25) return 'bg-yellow-500';
                return 'bg-gray-300';
            };

            const getStatusBadge = (project) => {
                if (project.hasOverdue) return <span className="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700">Overdue</span>;
                if (project.progress === 0) return <span className="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">Not Started</span>;
                if (project.progress === 100) return <span className="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700">Complete</span>;
                return <span className="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">In Progress</span>;
            };

            return (
                <div className="max-w-5xl mx-auto pb-20">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-xl mb-6 text-white">
                        <h3 className="text-2xl font-bold mb-1 flex items-center gap-2">
                            <Icons.Dashboard /> Dashboard
                        </h3>
                        <p className="text-indigo-100">Your GTD system at a glance</p>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <StatCard label="Inbox" value={inbox.length} icon={Icons.Inbox} color={inbox.length > 0 ? "text-red-600" : "text-green-600"} bgColor="bg-white border-gray-200" onClick={() => setView('inbox')} />
                        <StatCard label="Next Actions" value={nextActions.length} icon={Icons.Next} color="text-blue-600" bgColor="bg-white border-gray-200" onClick={() => setView('next')} />
                        <StatCard label="Waiting For" value={waitingFor.length} icon={Icons.Waiting} color="text-orange-600" bgColor="bg-white border-gray-200" onClick={() => setView('waiting')} />
                        <StatCard label="Done This Week" value={completedThisWeek.length} icon={Icons.Check} color="text-green-600" bgColor="bg-white border-gray-200" onClick={() => setView('done')} />
                    </div>

                    {/* Focus Today Section */}
                    {focusTasks.length > 0 && (
                        <div className="mb-8">
                            <div className="flex items-center justify-between mb-4">
                                <h4 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    <Icons.AlertCircle className="text-orange-500" />
                                    Focus Today
                                    {overdueCount > 0 && <span className="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700">{overdueCount} overdue</span>}
                                </h4>
                            </div>
                            <div className="bg-white rounded-xl border border-gray-200 divide-y">
                                {focusTasks.slice(0, 5).map(task => (
                                    <div key={task.id} onClick={() => onClick(task)} className="p-4 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <button onClick={(e) => { e.stopPropagation(); onCheck(task.id); }} className="w-5 h-5 rounded-full border-2 border-gray-300 hover:border-blue-500 flex items-center justify-center flex-shrink-0" />
                                            <div>
                                                <div className="font-medium text-gray-800">{task.text}</div>
                                                <div className="text-xs text-gray-500 flex items-center gap-2 mt-0.5">
                                                    {task.project && <span className="text-blue-600">{task.project}</span>}
                                                    {task.context && <span className="bg-gray-100 px-1.5 rounded">{task.context}</span>}
                                                </div>
                                            </div>
                                        </div>
                                        <span className={`text-sm font-medium ${new Date(task.dueDate + 'T00:00:00') < today ? 'text-red-600' : 'text-orange-600'}`}>
                                            {new Date(task.dueDate + 'T00:00:00') < today ? 'Overdue' : 'Today'}
                                        </span>
                                    </div>
                                ))}
                                {focusTasks.length > 5 && (
                                    <button onClick={() => setView('calendar')} className="w-full p-3 text-center text-sm text-blue-600 hover:bg-blue-50">
                                        View all {focusTasks.length} items in Calendar
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Projects Table */}
                    {projectStats.length > 0 && (
                        <div>
                            <div className="flex items-center justify-between mb-4">
                                <h4 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    <Icons.Project />
                                    Active Projects
                                </h4>
                                <button onClick={() => setView('projects')} className="text-sm text-blue-600 hover:underline">View all</button>
                            </div>
                            <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                <table className="w-full">
                                    <thead className="bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <tr>
                                            <th className="px-4 py-3">Project</th>
                                            <th className="px-4 py-3 hidden sm:table-cell">Due Date</th>
                                            <th className="px-4 py-3">Progress</th>
                                            <th className="px-4 py-3 hidden md:table-cell">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {projectStats.slice(0, 8).map(project => (
                                            <tr key={project.name} className="hover:bg-gray-50 cursor-pointer" onClick={() => setView('projects')}>
                                                <td className="px-4 py-3">
                                                    <div className="font-medium text-gray-800">{project.name}</div>
                                                    <div className="text-xs text-gray-500">{project.activeCount} active tasks</div>
                                                </td>
                                                <td className="px-4 py-3 hidden sm:table-cell">
                                                    {project.nextDue ? (
                                                        <span className={project.hasOverdue ? 'text-red-600 font-medium' : 'text-gray-600'}>
                                                            {formatDate(project.nextDue)}
                                                        </span>
                                                    ) : (
                                                        <span className="text-gray-400">-</span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3">
                                                    <div className="flex items-center gap-2">
                                                        <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden max-w-[100px]">
                                                            <div className={`h-full ${getProgressColor(project.progress)} transition-all`} style={{ width: `${project.progress}%` }} />
                                                        </div>
                                                        <span className="text-xs text-gray-600 w-10">{project.progress}%</span>
                                                    </div>
                                                </td>
                                                <td className="px-4 py-3 hidden md:table-cell">
                                                    {getStatusBadge(project)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Empty State */}
                    {projectStats.length === 0 && focusTasks.length === 0 && inbox.length === 0 && (
                        <div className="text-center text-gray-400 mt-12 flex flex-col items-center">
                            <div className="opacity-20 mb-4 scale-150"><Icons.TrendingUp /></div>
                            <p className="text-lg">All clear!</p>
                            <p className="text-sm mt-1">Add tasks to your inbox to get started</p>
                        </div>
                    )}
                </div>
            );
        };

        const GTDGuideView = ({ apiKey, setView }) => {
            const [expandedStep, setExpandedStep] = useState(null);
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);

            const toggleStep = (step) => setExpandedStep(expandedStep === step ? null : step);

            const steps = [
                {
                    id: 'capture',
                    title: 'Capture',
                    subtitle: 'Collect what has your attention',
                    icon: Icons.Inbox,
                    color: 'text-red-600',
                    bgColor: 'bg-red-50',
                    borderColor: 'border-red-200',
                    accentColor: 'bg-red-100',
                    description: 'The first step in GTD is getting everything out of your head. Every task, idea, commitment, or nagging thought goes into your Inbox. The goal is to capture 100% of what has your attention so your mind is free to focus.',
                    howTo: [
                        { label: 'Quick Capture', text: 'Go to Inbox and type a task in the input field. Press Enter to add it instantly.' },
                        { label: 'Brain Dump', text: 'Click the "Dump" button next to the Inbox input. Paste meeting notes, emails, or a stream of thoughts. AI will parse them into individual tasks.' },
                    ],
                    tips: [
                        'Capture everything — no filtering at this stage',
                        'Use Brain Dump for batch processing meeting notes or emails',
                        'The inbox is temporary — items should be clarified, not left here',
                    ],
                    appNav: 'inbox'
                },
                {
                    id: 'clarify',
                    title: 'Clarify',
                    subtitle: 'Process what each item means',
                    icon: Icons.Sparkles,
                    color: 'text-purple-600',
                    bgColor: 'bg-purple-50',
                    borderColor: 'border-purple-200',
                    accentColor: 'bg-purple-100',
                    description: 'For each item in your Inbox, ask: "Is this actionable?" If yes, decide the next physical action. If no, trash it, file it as reference, or move it to Someday/Maybe. This is where vague stuff becomes concrete.',
                    howTo: [
                        { label: 'Process Items', text: 'Click any inbox item to open the Clarify modal. Decide if it\'s actionable or not.' },
                        { label: 'Smart Clarify', text: 'Click the "Smart Clarify" button to let AI analyze your task, suggest a concrete next action, assign a context, and recommend a status.' },
                        { label: 'Decision Tree', text: 'Not actionable? → Trash, Someday, or Reference. Actionable? → Do It (if < 2 min), Delegate (Waiting For), or Defer (Next Actions).' },
                    ],
                    tips: [
                        'Process top-to-bottom — don\'t skip around',
                        'If it takes less than 2 minutes, do it right now',
                        'Smart Clarify works best with a Gemini API key (Settings)',
                        'Always define a concrete next physical action, not a vague goal',
                    ],
                    appNav: 'inbox'
                },
                {
                    id: 'organize',
                    title: 'Organize',
                    subtitle: 'Put things where they belong',
                    icon: Icons.Project,
                    color: 'text-blue-600',
                    bgColor: 'bg-blue-50',
                    borderColor: 'border-blue-200',
                    accentColor: 'bg-blue-100',
                    description: 'Once clarified, each item gets placed in the right list. Next Actions are things you can do now. Waiting For tracks delegated items. Projects group multi-step outcomes. Someday/Maybe holds future possibilities.',
                    howTo: [
                        { label: 'Next Actions', text: 'Your main work queue. These are concrete tasks you can act on right now, organized by context (@work, @home, etc.).' },
                        { label: 'Waiting For', text: 'Tasks you\'ve delegated or are waiting on someone else for. Assign an owner to track who.' },
                        { label: 'Projects', text: 'Any outcome requiring more than one step. Use the AI Project Breakdown to auto-generate next actions for a project.' },
                        { label: 'Calendar', text: 'Tasks with specific due dates. Color-coded by urgency (overdue, today, tomorrow, this week).' },
                        { label: 'Contexts', text: 'Tag tasks with @work, @home, @calls, etc. Filter by context to see what you can do right now based on where you are.' },
                    ],
                    tips: [
                        'Every project should have at least one Next Action',
                        'Use contexts to batch similar tasks (e.g., all @calls at once)',
                        'Set due dates only for hard deadlines, not aspirational ones',
                        'Assign owners to Waiting For items so you know who to follow up with',
                    ],
                    appNav: 'next'
                },
                {
                    id: 'reflect',
                    title: 'Reflect',
                    subtitle: 'Review and update your system',
                    icon: Icons.Review,
                    color: 'text-indigo-600',
                    bgColor: 'bg-indigo-50',
                    borderColor: 'border-indigo-200',
                    accentColor: 'bg-indigo-100',
                    description: 'Regular reviews keep your system trustworthy. The Weekly Review is the critical habit — it\'s where you empty your inbox, review all projects and next actions, and make sure nothing is falling through the cracks.',
                    howTo: [
                        { label: 'Weekly Review', text: 'Go to the Weekly Review page. It shows your Inbox count, Active Projects with their tasks, Waiting For items, and all Next Actions in one place.' },
                        { label: 'Dashboard', text: 'Your daily overview. Check Focus Today for urgent/overdue items, see project progress bars, and review summary stats.' },
                    ],
                    tips: [
                        'Do a Weekly Review every week — this is the most important GTD habit',
                        'Start by emptying your Inbox completely',
                        'Review every project: is the next action still current?',
                        'Check Waiting For: do you need to follow up with anyone?',
                        'Scan Someday/Maybe: should anything move to active?',
                    ],
                    appNav: 'weekly_review'
                },
                {
                    id: 'engage',
                    title: 'Engage',
                    subtitle: 'Do the right work with confidence',
                    icon: Icons.Next,
                    color: 'text-green-600',
                    bgColor: 'bg-green-50',
                    borderColor: 'border-green-200',
                    accentColor: 'bg-green-100',
                    description: 'With a trusted system in place, you can confidently choose what to work on. Use your context, available time, energy level, and priorities to pick the right Next Action. Check the task\'s checkbox when done.',
                    howTo: [
                        { label: 'Next Actions', text: 'Your primary work view. Pick tasks based on your current context, energy, and available time.' },
                        { label: 'Focus Today', text: 'Check the Dashboard for overdue and due-today items that need immediate attention.' },
                        { label: 'Complete Tasks', text: 'Click the checkbox on any task to mark it done. Completed tasks are tracked in the Completed view.' },
                    ],
                    tips: [
                        'Trust your system — if it\'s not on a list, it doesn\'t exist',
                        'Use contexts: at @work? Filter for @work tasks only',
                        'Low energy? Pick a quick, easy Next Action to build momentum',
                        'When you finish a project task, immediately define the next one',
                    ],
                    appNav: 'next'
                }
            ];

            const handleChatSend = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;
                const userMsg = chatInput.trim();
                setChatInput('');
                setChatMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setIsChatLoading(true);

                if (apiKey) {
                    const systemPrompt = `You are a friendly GTD (Getting Things Done) expert assistant built into a GTD productivity app called "GTD Focus". Answer the user's question about the GTD methodology, productivity workflows, or how to use the app effectively.

The app has these features:
- Inbox: capture tasks quickly, or use Brain Dump to paste unstructured text and have AI parse it
- Clarify: click any inbox item to process it. Smart Clarify uses AI to suggest next actions
- Organize: Next Actions, Waiting For, Projects, Calendar, Someday/Maybe, Contexts (@work, @home, etc.)
- Reflect: Weekly Review page shows all projects/actions at a glance; Dashboard shows daily focus
- Engage: Work from Next Actions filtered by context; check off tasks when done
- AI features require a Gemini API key in Settings

Keep answers concise (2-4 sentences for simple questions, more for complex ones). Be practical and specific. Reference app features when relevant. Return a JSON object: { "answer": "your answer here" }`;
                    const result = await callGemini(apiKey, userMsg, systemPrompt);
                    if (result && result.answer) {
                        setChatMessages(prev => [...prev, { role: 'ai', text: result.answer }]);
                    } else {
                        setChatMessages(prev => [...prev, { role: 'ai', text: "I couldn't process that. Please check your API key in Settings and try again." }]);
                    }
                } else {
                    const faq = {
                        'inbox': 'Your Inbox is where you capture everything that has your attention. Go to the Inbox view and type a task, or use Brain Dump to paste unstructured text. Don\'t organize here — just capture.',
                        'clarify': 'Click any Inbox item to open the Clarify modal. Ask "Is this actionable?" If yes, decide the next action and move it to Next Actions, Waiting For, or a Project. If not, Trash it, save as Reference, or move to Someday/Maybe.',
                        'organize': 'After clarifying, tasks go to: Next Actions (do soon), Waiting For (delegated), Projects (multi-step), Calendar (date-specific), or Someday/Maybe (future). Use contexts like @work or @home to filter.',
                        'review': 'The Weekly Review is essential. Go to Weekly Review to see all active projects, waiting items, and next actions. Do this every week to keep your system trustworthy.',
                        'project': 'A project is any outcome requiring more than one action step. In the Clarify modal, type a project name and click the sparkle icon to have AI break it down into 3-5 next actions.',
                        'context': 'Contexts (like @work, @home, @calls) help you filter tasks by where you are or what tools you have. Add custom contexts in Settings.',
                        'brain dump': 'Brain Dump lets you paste unstructured text (meeting notes, emails, thoughts) and AI parses it into individual tasks. Find it next to the Inbox input field.',
                        'api': 'Go to Settings and paste your Gemini API key. This enables Smart Clarify (AI task analysis), Brain Dump AI parsing, and Project Breakdown features.',
                        'delegate': 'When you delegate a task, move it to Waiting For and assign an owner. Add delegate names in Settings so they appear in the dropdown.',
                    };
                    let matched = null;
                    const lowerMsg = userMsg.toLowerCase();
                    for (const [key, answer] of Object.entries(faq)) {
                        if (lowerMsg.includes(key)) { matched = answer; break; }
                    }
                    setChatMessages(prev => [...prev, {
                        role: 'ai',
                        text: matched || 'For detailed AI-powered answers to your GTD questions, add your Gemini API key in Settings. In the meantime, try asking about: inbox, clarify, organize, review, projects, contexts, brain dump, delegate, or API setup.'
                    }]);
                }
                setIsChatLoading(false);
            };

            return (
                <div className="max-w-3xl mx-auto pb-20">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-emerald-500 to-teal-600 p-6 rounded-xl mb-8 text-white">
                        <h3 className="text-2xl font-bold mb-1 flex items-center gap-2">
                            <Icons.Guide /> GTD Workflow Guide
                        </h3>
                        <p className="text-emerald-100">Learn the Getting Things Done methodology and how to use this app effectively</p>
                    </div>

                    {/* Overview */}
                    <div className="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                        <h4 className="text-lg font-bold text-gray-800 mb-3">What is GTD?</h4>
                        <p className="text-gray-600 text-sm leading-relaxed mb-4">
                            Getting Things Done (GTD) is a productivity methodology by David Allen. The core idea: your mind is for having ideas, not holding them.
                            By capturing everything in a trusted system and processing it through a clear workflow, you free mental space to focus on actually doing the work.
                        </p>
                        <div className="flex flex-wrap gap-2">
                            {steps.map((step, i) => (
                                <button key={step.id} onClick={() => toggleStep(step.id)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium border transition-colors ${expandedStep === step.id ? step.bgColor + ' ' + step.borderColor + ' ' + step.color : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-gray-100'}`}>
                                    <span className="text-xs text-gray-400 font-bold">{i + 1}</span>
                                    <step.icon />
                                    {step.title}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Steps */}
                    <div className="space-y-3 mb-8">
                        {steps.map((step, index) => (
                            <div key={step.id} className={`bg-white rounded-xl border overflow-hidden transition-all ${expandedStep === step.id ? step.borderColor + ' shadow-md' : 'border-gray-200'}`}>
                                <button onClick={() => toggleStep(step.id)} className="w-full p-5 flex items-center justify-between text-left">
                                    <div className="flex items-center gap-4">
                                        <div className={`w-10 h-10 rounded-lg ${step.accentColor} ${step.color} flex items-center justify-center`}>
                                            <step.icon />
                                        </div>
                                        <div>
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs font-bold text-gray-400 uppercase">Step {index + 1}</span>
                                            </div>
                                            <h4 className={`text-lg font-bold ${step.color}`}>{step.title}</h4>
                                            <p className="text-sm text-gray-500">{step.subtitle}</p>
                                        </div>
                                    </div>
                                    {expandedStep === step.id ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                                </button>

                                {expandedStep === step.id && (
                                    <div className="px-5 pb-5 border-t border-gray-100">
                                        <p className="text-gray-600 text-sm leading-relaxed mt-4 mb-5">{step.description}</p>

                                        <div className="mb-5">
                                            <h5 className="text-sm font-bold text-gray-700 uppercase tracking-wider mb-3">How to do it in the app</h5>
                                            <div className="space-y-2">
                                                {step.howTo.map((item, i) => (
                                                    <div key={i} className={`p-3 rounded-lg ${step.bgColor} border ${step.borderColor}`}>
                                                        <span className={`font-bold text-sm ${step.color}`}>{item.label}:</span>
                                                        <span className="text-sm text-gray-700 ml-1">{item.text}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="mb-4">
                                            <h5 className="text-sm font-bold text-gray-700 uppercase tracking-wider mb-3">Tips</h5>
                                            <ul className="space-y-1.5">
                                                {step.tips.map((tip, i) => (
                                                    <li key={i} className="flex items-start gap-2 text-sm text-gray-600">
                                                        <span className={`mt-1 w-1.5 h-1.5 rounded-full ${step.accentColor} flex-shrink-0`}></span>
                                                        {tip}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>

                                        <button onClick={() => setView(step.appNav)} className={`inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium rounded-lg border ${step.borderColor} ${step.color} ${step.bgColor} hover:opacity-80 transition-opacity`}>
                                            <step.icon /> Go to {step.title}
                                        </button>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* AI Q&A Section */}
                    <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div className="p-5 border-b bg-gradient-to-r from-purple-50 to-indigo-50">
                            <h4 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <Icons.Sparkles /> Ask the GTD Guide
                            </h4>
                            <p className="text-sm text-gray-500 mt-1">
                                {apiKey ? 'AI-powered answers to your GTD and workflow questions' : 'Add a Gemini API key in Settings for AI-powered answers, or ask about common topics'}
                            </p>
                        </div>
                        <div className="p-4">
                            {chatMessages.length > 0 && (
                                <div className="space-y-3 mb-4 max-h-80 overflow-y-auto">
                                    {chatMessages.map((msg, i) => (
                                        <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[80%] px-4 py-2.5 rounded-xl text-sm leading-relaxed ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-sm' : 'bg-gray-100 text-gray-800 rounded-bl-sm'}`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    ))}
                                    {isChatLoading && (
                                        <div className="flex justify-start">
                                            <div className="bg-gray-100 px-4 py-2.5 rounded-xl rounded-bl-sm text-sm text-gray-500 flex items-center gap-2">
                                                <span className="w-4 h-4 border-2 border-gray-300 border-t-purple-500 rounded-full spinner"></span>
                                                Thinking...
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            {chatMessages.length === 0 && (
                                <div className="mb-4">
                                    <p className="text-sm text-gray-400 mb-3">Try asking:</p>
                                    <div className="flex flex-wrap gap-2">
                                        {['How do I process my inbox?', 'What makes a good next action?', 'How do I do a weekly review?', 'How do projects work?'].map(q => (
                                            <button key={q} onClick={() => { setChatInput(q); }} className="text-xs px-3 py-1.5 bg-gray-50 border border-gray-200 rounded-full text-gray-600 hover:bg-gray-100 transition-colors">
                                                {q}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <form onSubmit={handleChatSend} className="flex gap-2">
                                <input
                                    type="text"
                                    value={chatInput}
                                    onChange={(e) => setChatInput(e.target.value)}
                                    placeholder="Ask a question about GTD..."
                                    className="flex-1 p-3 border border-gray-200 rounded-lg text-sm focus:border-purple-400 focus:shadow-md outline-none transition-shadow"
                                />
                                <button type="submit" disabled={!chatInput.trim() || isChatLoading} className="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center">
                                    <Icons.Send />
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const BrainDumpModal = ({ isOpen, onClose, onAddTasks, contexts, apiKey }) => {
            const [rawText, setRawText] = useState('');
            const [parsedItems, setParsedItems] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const { voiceState: dumpVoiceState, transcript: dumpTranscript, setTranscript: setDumpTranscript, startRecording: startDumpRecording, stopRecording: stopDumpRecording, loadProgress: dumpLoadProgress } = useVoiceCapture();
            const prevDumpVoiceRef = useRef('idle');

            useEffect(() => { if (!isOpen) { setRawText(''); setParsedItems(null); setIsProcessing(false); } }, [isOpen]);

            // Append voice transcript to rawText when recording completes
            useEffect(() => {
                if (prevDumpVoiceRef.current !== 'idle' && dumpVoiceState === 'idle' && dumpTranscript) {
                    setRawText(prev => prev ? prev.trimEnd() + '\n' + dumpTranscript : dumpTranscript);
                    setDumpTranscript('');
                }
                prevDumpVoiceRef.current = dumpVoiceState;
            }, [dumpVoiceState, dumpTranscript, setDumpTranscript]);

            if (!isOpen) return null;

            const handleProcess = async () => {
                if (!rawText.trim()) return;
                setIsProcessing(true);

                if (apiKey) {
                    const contextList = contexts.join(', ');
                    const systemPrompt = `You are a GTD (Getting Things Done) expert. The user is doing a brain dump. Parse the following unstructured text into individual actionable items or inbox captures.

For each item, provide:
- "text": A clear, concise task description
- "status": One of "inbox", "next", "waiting", "someday", "trash" (default to "inbox" if unclear)
- "context": Best matching context from [${contextList}], or "" if none fits
- "project": A suggested project name if the item relates to a larger effort, or "" if standalone
- "dueDate": YYYY-MM-DD if a date/deadline is mentioned, or null
- "owner": Person's name if delegated/waiting on someone, or null

Return a JSON array of objects. Extract EVERY distinct actionable item or thought — don't merge separate items. If something is clearly not actionable (e.g. just a note or observation), still include it with status "inbox".`;
                    const result = await callGemini(apiKey, rawText, systemPrompt);
                    if (Array.isArray(result)) {
                        setParsedItems(result.map((item) => ({ ...item, id: generateId(), selected: true })));
                    }
                } else {
                    // Fallback: split on newlines
                    const lines = rawText.split(/\n/).map(l => l.trim()).filter(l => l.length > 0);
                    setParsedItems(lines.map((line, i) => ({
                        id: generateId(), text: line, status: 'inbox', context: '', project: '', dueDate: null, owner: null, selected: true
                    })));
                }
                setIsProcessing(false);
            };

            const toggleItem = (id) => { setParsedItems(parsedItems.map(item => item.id === id ? { ...item, selected: !item.selected } : item)); };
            const updateItem = (id, field, value) => { setParsedItems(parsedItems.map(item => item.id === id ? { ...item, [field]: value } : item)); };
            const selectAll = () => { setParsedItems(parsedItems.map(item => ({ ...item, selected: true }))); };
            const selectNone = () => { setParsedItems(parsedItems.map(item => ({ ...item, selected: false }))); };

            const handleAddAll = () => {
                const selected = parsedItems.filter(item => item.selected);
                if (selected.length === 0) return;
                const newTasks = selected.map(item => ({
                    id: item.id,
                    text: item.text,
                    status: item.status || 'inbox',
                    context: item.context || undefined,
                    project: item.project || undefined,
                    dueDate: item.dueDate || undefined,
                    owner: item.owner || undefined,
                    created: new Date().toISOString(),
                    notes: 'From Brain Dump'
                }));
                onAddTasks(newTasks);
                onClose();
            };

            const getStatusColor = (status) => {
                switch(status) {
                    case 'next': return 'bg-blue-100 text-blue-700';
                    case 'waiting': return 'bg-orange-100 text-orange-700';
                    case 'someday': return 'bg-yellow-100 text-yellow-700';
                    case 'trash': return 'bg-red-100 text-red-700';
                    default: return 'bg-gray-100 text-gray-700';
                }
            };

            const selectedCount = parsedItems ? parsedItems.filter(i => i.selected).length : 0;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-5 border-b bg-gray-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Icons.BrainDump /> Brain Dump</h3>
                            <button onClick={onClose} className="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">{parsedItems ? 'Discard' : 'Cancel'}</button>
                        </div>

                        {!parsedItems ? (
                            <div className="p-6 flex flex-col flex-1">
                                <p className="text-sm text-gray-500 mb-3">Paste meeting notes, a stream of thoughts, an email, a list — anything. {apiKey ? 'AI will parse it into individual tasks.' : 'Items will be split by line.'}</p>
                                <textarea
                                    value={rawText}
                                    onChange={(e) => setRawText(e.target.value)}
                                    placeholder={"Paste or type anything here...\n\nExamples:\n- Meeting notes from standup\n- A forwarded email with action items\n- Stream of consciousness brain dump\n- A bullet list of todos"}
                                    className="flex-1 min-h-[200px] w-full p-4 border border-gray-200 rounded-lg text-sm resize-none focus:border-blue-400 focus:shadow-md outline-none transition-shadow"
                                    autoFocus
                                />
                                <div className="flex items-center gap-2 mt-3">
                                    {dumpVoiceState === 'idle' ? (
                                        <button type="button" onClick={startDumpRecording} className="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-blue-300 transition-all"><Icons.Microphone /> Voice capture</button>
                                    ) : dumpVoiceState === 'loading' ? (
                                        <div className="flex items-center gap-2 px-3 py-2 text-sm text-purple-600"><span className="w-4 h-4 border-2 border-purple-300 border-t-purple-600 rounded-full spinner"></span> Loading voice model ({dumpLoadProgress}%)...</div>
                                    ) : dumpVoiceState === 'recording' ? (
                                        <button type="button" onClick={stopDumpRecording} className="flex items-center gap-2 px-3 py-2 text-sm text-red-600 border border-red-200 rounded-lg bg-red-50 recording-pulse"><Icons.Stop /> Stop recording</button>
                                    ) : (
                                        <div className="flex items-center gap-2 px-3 py-2 text-sm text-blue-600"><span className="w-4 h-4 border-2 border-blue-300 border-t-blue-600 rounded-full spinner"></span> Transcribing...</div>
                                    )}
                                    {dumpVoiceState === 'recording' && dumpTranscript && <span className="text-xs text-gray-400 italic truncate flex-1">{dumpTranscript.slice(-60)}...</span>}
                                </div>
                                <button
                                    onClick={handleProcess}
                                    disabled={!rawText.trim() || isProcessing}
                                    className="mt-4 w-full py-3 rounded-lg font-bold text-white transition-all disabled:opacity-50 ai-gradient flex items-center justify-center gap-2"
                                >
                                    {isProcessing ? (
                                        <><span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full spinner"></span> Processing...</>
                                    ) : (
                                        <>{apiKey ? <><Icons.Sparkles /> Process with AI</> : 'Split into items'}</>
                                    )}
                                </button>
                            </div>
                        ) : (
                            <div className="flex flex-col flex-1 overflow-hidden">
                                <div className="px-6 pt-4 pb-2 flex items-center justify-between border-b">
                                    <p className="text-sm text-gray-500">{parsedItems.length} items found — {selectedCount} selected</p>
                                    <div className="flex gap-2 text-xs">
                                        <button onClick={selectAll} className="text-blue-600 hover:underline">Select all</button>
                                        <span className="text-gray-300">|</span>
                                        <button onClick={selectNone} className="text-blue-600 hover:underline">Select none</button>
                                        <span className="text-gray-300">|</span>
                                        <button onClick={() => setParsedItems(null)} className="text-gray-500 hover:underline">Back</button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {parsedItems.map(item => (
                                        <div key={item.id} className={`p-3 rounded-lg border transition-all ${item.selected ? 'border-blue-200 bg-white shadow-sm' : 'border-gray-100 bg-gray-50 opacity-50'}`}>
                                            <div className="flex items-start gap-3">
                                                <button onClick={() => toggleItem(item.id)} className={`mt-0.5 w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 transition-colors ${item.selected ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}`}>
                                                    {item.selected && <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>}
                                                </button>
                                                <div className="flex-1 min-w-0">
                                                    <input type="text" value={item.text} onChange={(e) => updateItem(item.id, 'text', e.target.value)} className="w-full font-medium text-gray-800 bg-transparent outline-none text-sm" />
                                                    <div className="flex items-center gap-2 mt-1.5 flex-wrap">
                                                        <select value={item.status} onChange={(e) => updateItem(item.id, 'status', e.target.value)} className={`text-xs px-2 py-0.5 rounded-full border-0 cursor-pointer ${getStatusColor(item.status)}`}>
                                                            <option value="inbox">Inbox</option>
                                                            <option value="next">Next</option>
                                                            <option value="waiting">Waiting</option>
                                                            <option value="someday">Someday</option>
                                                            <option value="trash">Trash</option>
                                                        </select>
                                                        {item.context && <span className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">{item.context}</span>}
                                                        {item.project && <span className="text-xs text-blue-600 flex items-center gap-0.5"><Icons.Project /> {item.project}</span>}
                                                        {item.dueDate && <span className="text-xs text-gray-500">{item.dueDate}</span>}
                                                        {item.owner && <span className="text-xs text-purple-600 flex items-center gap-0.5"><Icons.User /> {item.owner}</span>}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 border-t bg-gray-50">
                                    <button
                                        onClick={handleAddAll}
                                        disabled={selectedCount === 0}
                                        className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors disabled:opacity-50"
                                    >
                                        Add {selectedCount} item{selectedCount !== 1 ? 's' : ''} to GTD
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ProcessModal = ({ task, isOpen, onClose, onUpdate, onAddSubtasks, contexts, delegates, apiKey }) => {
            const [localTask, setLocalTask] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [aiSuggestion, setAiSuggestion] = useState(null);
            const [isBreakingDown, setIsBreakingDown] = useState(false);

            // Sync local state from prop when a new task is opened
            useEffect(() => {
                if (task) setLocalTask({ ...task });
                setAiSuggestion(null); setIsAnalyzing(false); setIsBreakingDown(false);
            }, [task]);

            if (!isOpen || !task || !localTask) return null;

            const handleClose = () => {
                // Push local edits to parent (single save) on close
                onUpdate(localTask);
                onClose();
            };
            const moveTask = (status) => { onUpdate({ ...localTask, status }); onClose(); };
            const updateLocal = (updates) => { setLocalTask(prev => ({ ...prev, ...updates })); };

            const handleAIClarify = async () => {
                if(!apiKey) { alert("Please enter a Gemini API Key in Settings first."); return; }
                setIsAnalyzing(true);
                const contextList = contexts.join(', ');
                const systemPrompt = `GTD expert. Analyze inbox item. 1. Clarify to concrete next action. 2. Context from: [${contextList}]. 3. Status (next, waiting, project, someday, trash, reference). 4. Suggest Project Name. 5. Due Date (YYYY-MM-DD) if mentioned. 6. Waiting owner if mentioned. Return JSON: { "clarifiedText": string, "context": string, "status": string, "project": string, "dueDate": string|null, "owner": string|null }`;
                const result = await callGemini(apiKey, localTask.text, systemPrompt);
                if (result) { updateLocal({ text: result.clarifiedText || localTask.text, context: result.context || localTask.context, project: result.project || localTask.project, dueDate: result.dueDate || localTask.dueDate, owner: result.owner || localTask.owner }); setAiSuggestion(result.status); }
                setIsAnalyzing(false);
            };
            const handleAIBreakdown = async () => {
                if(!apiKey) { alert("Please enter a Gemini API Key in Settings first."); return; }
                if (!localTask.project && !localTask.text) return;
                setIsBreakingDown(true);
                const projectTitle = localTask.project || localTask.text;
                const systemPrompt = `GTD expert. Project: "${projectTitle}". Break down into 3-5 next actions. Return JSON array of strings.`;
                const result = await callGemini(apiKey, projectTitle, systemPrompt);
                if (Array.isArray(result)) { onAddSubtasks(result, projectTitle); onUpdate({ ...localTask, text: projectTitle, status: 'project', project: projectTitle }); alert(`Created ${result.length} actions!`); onClose(); }
                setIsBreakingDown(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-5 border-b bg-gray-50 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">Clarify {aiSuggestion && <span className="text-xs bg-purple-100 text-purple-700 px-2 rounded-full">AI: {aiSuggestion}</span>}</h3>
                            <div className="flex items-center gap-2">
                                <button onClick={handleAIClarify} disabled={isAnalyzing} className="flex items-center gap-1 px-3 py-1.5 text-xs font-bold text-white rounded-md ai-gradient hover:opacity-90 disabled:opacity-50">{isAnalyzing ? '...' : <><Icons.Sparkles /> Smart Clarify</>}</button>
                                <button onClick={handleClose} className="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-green-700 bg-green-50 border border-green-200 rounded-md hover:bg-green-100 transition-colors"><Icons.Check /> Done</button>
                            </div>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <div className="mb-6"><label className="block text-xs text-gray-500 font-bold uppercase mb-1">Task Name</label><input type="text" value={localTask.text} onChange={(e) => updateLocal({ text: e.target.value })} className="w-full text-lg font-medium border-b-2 focus:border-blue-500 outline-none py-1" /></div>
                            <div className="mb-6"><label className="block text-xs text-gray-500 font-bold uppercase mb-2">Actionable?</label><div className="grid grid-cols-2 gap-3"><button onClick={() => moveTask('trash')} className={`flex items-center justify-center px-4 py-2 border rounded hover:bg-red-50 ${aiSuggestion === 'trash' ? 'ring-2 ring-purple-400 border-purple-400 bg-red-50' : 'border-red-200 text-red-600'}`}><Icons.Trash /> Trash</button><button onClick={() => moveTask('someday')} className={`flex items-center justify-center px-4 py-2 border rounded hover:bg-yellow-50 ${aiSuggestion === 'someday' ? 'ring-2 ring-purple-400 border-purple-400 bg-yellow-50' : 'border-yellow-200 text-yellow-600'}`}><Icons.Someday /> Someday</button><button onClick={() => moveTask('reference')} className={`col-span-2 flex items-center justify-center px-4 py-2 border rounded hover:bg-gray-50 ${aiSuggestion === 'reference' ? 'ring-2 ring-purple-400 border-purple-400 bg-gray-50' : 'border-gray-200 text-gray-600'}`}><Icons.Reference /> Reference</button></div></div>
                            <div className="mb-4"><label className="block text-xs text-gray-500 font-bold uppercase mb-2">Yes (Actionable)</label><div className="space-y-2"><button onClick={() => moveTask('done')} className="w-full flex items-center justify-between px-4 py-3 bg-green-50 text-green-700 rounded hover:bg-green-100 border border-green-200"><div className="flex items-center"><Icons.Check /><span className="ml-2 font-medium">Do It (Done)</span></div></button><div className="grid grid-cols-2 gap-3 pt-2"><button onClick={() => moveTask('waiting')} className={`flex flex-col items-center justify-center p-3 border rounded hover:bg-gray-50 ${aiSuggestion === 'waiting' ? 'ring-2 ring-purple-400' : ''}`}><Icons.Waiting /><span className="mt-1 text-sm">Delegate</span></button><button onClick={() => moveTask('next')} className={`flex flex-col items-center justify-center p-3 border rounded bg-blue-50 ${aiSuggestion === 'next' ? 'ring-2 ring-purple-400 border-purple-400' : 'border-blue-200 text-blue-700'}`}><Icons.Next /><span className="mt-1 text-sm">Defer</span></button></div></div></div>
                            <div className="grid grid-cols-2 gap-4 mt-6 pt-4 border-t">
                                <div><label className="block text-xs text-gray-500 mb-1">Context</label><select value={localTask.context || ''} onChange={(e) => updateLocal({ context: e.target.value })} className="w-full p-2 bg-gray-50 rounded border text-sm"><option value="">None</option>{contexts.map(ctx => <option key={ctx} value={ctx}>{ctx}</option>)}</select></div>
                                <div><label className="block text-xs text-gray-500 mb-1">Due Date</label><input type="date" value={localTask.dueDate || ''} onChange={(e) => updateLocal({ dueDate: e.target.value })} className="w-full p-2 bg-gray-50 rounded border text-sm" /></div>
                                {(localTask.status === 'waiting' || localTask.owner) && <div className="col-span-2"><label className="block text-xs text-gray-500 mb-1">Assigned To</label><div className="flex gap-2"><select value={localTask.owner || ''} onChange={(e) => updateLocal({ owner: e.target.value })} className="flex-1 p-2 bg-gray-50 rounded border text-sm"><option value="">Select...</option>{delegates.map(d => <option key={d} value={d}>{d}</option>)}</select><input type="text" placeholder="Or type..." value={localTask.owner || ''} onChange={(e) => updateLocal({ owner: e.target.value })} className="flex-1 p-2 bg-gray-50 rounded border text-sm" /></div></div>}
                                <div className="col-span-2"><label className="block text-xs text-gray-500 mb-1">Project</label><div className="relative"><input type="text" placeholder="Project Name..." value={localTask.project || ''} onChange={(e) => updateLocal({ project: e.target.value })} className="w-full p-2 bg-gray-50 rounded border text-sm pr-8" />{(localTask.project || localTask.text) && <button onClick={handleAIBreakdown} disabled={isBreakingDown} className="absolute right-1 top-1 p-1 text-purple-600 hover:bg-purple-100 rounded">{isBreakingDown ? '...' : <Icons.Sparkles />}</button>}</div></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [loginLoading, setLoginLoading] = useState(false);
            const firebase = useFirebase();

            const { tasks, setTasks, contexts, setContexts, delegates, setDelegates, apiKey, setApiKey, loaded, saveStatus } = useFirebaseData(user);

            const [view, setView] = useState('dashboard');
            const [newTask, setNewTask] = useState('');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [processingTask, setProcessingTask] = useState(null);
            const [isBrainDumpOpen, setIsBrainDumpOpen] = useState(false);

            const { voiceState: inboxVoiceState, transcript: inboxTranscript, setTranscript: setInboxTranscript, startRecording: startInboxRecording, stopRecording: stopInboxRecording, loadProgress: inboxLoadProgress } = useVoiceCapture();

            // Fill inbox input from voice transcript
            useEffect(() => {
                if (inboxTranscript) setNewTask(inboxTranscript);
            }, [inboxTranscript]);

            // Listen for auth state
            useEffect(() => {
                if (!firebase) return;
                const unsubscribe = firebase.onAuthStateChanged((u) => {
                    setUser(u);
                    setAuthLoading(false);
                });
                return unsubscribe;
            }, [firebase]);

            const handleLogin = async () => {
                setLoginLoading(true);
                try { await firebase.signInWithPopup(); }
                catch (err) { console.error("Login error:", err); alert("Login failed. Please try again."); }
                setLoginLoading(false);
            };
            const handleLogout = async () => {
                await firebase.signOut();
                setUser(null);
            };

            const handleAddTask = (e) => {
                e.preventDefault(); if (!newTask.trim()) return;
                const task = { id: generateId(), text: newTask, status: 'inbox', created: new Date().toISOString() };
                setTasks(prev => [task, ...prev]); setNewTask('');
            };
            const updateTask = useCallback((updatedTask) => {
                setTasks(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
            }, [setTasks]);
            const addMultipleTasks = (newTitles, projectName) => {
                const newTasks = newTitles.map((title) => ({ id: generateId(), text: title, status: 'next', created: new Date().toISOString(), project: projectName, notes: 'Generated by AI' }));
                setTasks(prev => [...newTasks, ...prev]);
            };
            const addBrainDumpTasks = (newTasks) => { setTasks(prev => [...newTasks, ...prev]); };
            const markDone = useCallback((id) => { setTasks(prev => prev.map(t => t.id === id ? { ...t, status: t.status === 'done' ? 'inbox' : 'done', completedAt: t.status === 'done' ? undefined : new Date().toISOString() } : t)); }, [setTasks]);
            const deleteCompleted = () => { if(confirm("Clear completed?")) setTasks(prev => prev.filter(t => t.status !== 'done' && t.status !== 'trash')); };
            const filteredTasks = useMemo(() => {
                if (view === 'projects') return tasks.filter(t => t.status !== 'trash' && t.status !== 'done' && t.project);
                return tasks.filter(t => { if (view === 'all') return t.status !== 'trash'; if (view === 'done') return t.status === 'done'; return t.status === view; });
            }, [tasks, view]);
            const counts = useMemo(() => { const c = { inbox: 0, next: 0, waiting: 0, someday: 0, reference: 0, done: 0, calendar: 0 }; tasks.forEach(t => { if (c[t.status] !== undefined) c[t.status]++; if (t.dueDate && t.status !== 'done' && t.status !== 'trash') c.calendar++; }); return c; }, [tasks]);
            const renderProjectView = () => {
                const projects = [...new Set(tasks.filter(t => t.project && t.status !== 'done' && t.status !== 'trash').map(t => t.project))];
                if (projects.length === 0) return <div className="text-center text-gray-400 mt-20">No active projects.</div>;
                return <div className="space-y-8">{projects.map(proj => (<div key={proj}><h3 className="text-lg font-bold text-gray-800 mb-3 border-b pb-1">{proj}</h3><div className="space-y-2">{tasks.filter(t => t.project === proj && t.status !== 'done' && t.status !== 'trash').map(task => (<TaskItem key={task.id} task={task} onCheck={markDone} onClick={setProcessingTask} />))}</div></div>))}</div>;
            };

            // Loading / Login screens
            if (authLoading || !firebase) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
                        <div className="text-center"><div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full spinner mx-auto mb-4"></div><p className="text-gray-500">Loading...</p></div>
                    </div>
                );
            }
            if (!user) {
                return <LoginScreen onLogin={handleLogin} loading={loginLoading} />;
            }
            if (!loaded) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
                        <div className="text-center"><div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full spinner mx-auto mb-4"></div><p className="text-gray-500">Loading your data...</p></div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen overflow-hidden">
                    {isMobileMenuOpen && <div className="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden" onClick={() => setIsMobileMenuOpen(false)}></div>}
                    <aside className={`fixed lg:static inset-y-0 left-0 z-30 w-64 bg-white border-r border-gray-200 transform transition-transform duration-300 ease-in-out ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                        <div className="h-full flex flex-col">
                            <div className="p-6 border-b border-gray-100 flex items-center justify-between"><h1 className="text-xl font-bold text-gray-800 flex items-center gap-2"><span className="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center text-xs font-bold">GTD</span> Focus</h1><button className="lg:hidden" onClick={() => setIsMobileMenuOpen(false)}><svg className="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button></div>
                            <nav className="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
                                <SidebarItem active={view === 'dashboard'} label="Dashboard" count={0} icon={Icons.Dashboard} onClick={() => {setView('dashboard'); setIsMobileMenuOpen(false);}} />
                                <div className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-4 mb-2 mt-4">Capture</div>
                                <SidebarItem active={view === 'inbox'} label="Inbox" count={counts.inbox} icon={Icons.Inbox} onClick={() => {setView('inbox'); setIsMobileMenuOpen(false);}} />
                                <div className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-4 mb-2 mt-6">Organize</div>
                                <SidebarItem active={view === 'next'} label="Next Actions" count={counts.next} icon={Icons.Next} onClick={() => {setView('next'); setIsMobileMenuOpen(false);}} />
                                <SidebarItem active={view === 'waiting'} label="Waiting For" count={counts.waiting} icon={Icons.Waiting} onClick={() => {setView('waiting'); setIsMobileMenuOpen(false);}} />
                                <SidebarItem active={view === 'projects'} label="Projects" count={0} icon={Icons.Project} onClick={() => {setView('projects'); setIsMobileMenuOpen(false);}} />
                                <SidebarItem active={view === 'calendar'} label="Calendar" count={counts.calendar} icon={Icons.Calendar} onClick={() => {setView('calendar'); setIsMobileMenuOpen(false);}} />
                                <div className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-4 mb-2 mt-6">Review</div>
                                <SidebarItem active={view === 'weekly_review'} label="Weekly Review" count={0} icon={Icons.Review} onClick={() => {setView('weekly_review'); setIsMobileMenuOpen(false);}} />
                                <SidebarItem active={view === 'someday'} label="Someday/Maybe" count={counts.someday} icon={Icons.Someday} onClick={() => {setView('someday'); setIsMobileMenuOpen(false);}} />
                                <SidebarItem active={view === 'reference'} label="Reference" count={counts.reference} icon={Icons.Reference} onClick={() => {setView('reference'); setIsMobileMenuOpen(false);}} />
                                <SidebarItem active={view === 'done'} label="Completed" count={counts.done} icon={Icons.Done} onClick={() => {setView('done'); setIsMobileMenuOpen(false);}} />
                                <div className="mt-6 border-t pt-4">
                                    <SidebarItem active={view === 'guide'} label="GTD Guide" count={0} icon={Icons.Guide} onClick={() => {setView('guide'); setIsMobileMenuOpen(false);}} />
                                    <SidebarItem active={view === 'settings'} label="Settings" count={0} icon={Icons.Settings} onClick={() => {setView('settings'); setIsMobileMenuOpen(false);}} />
                                </div>
                            </nav>
                            {view === 'done' && <div className="p-4 border-t"><button onClick={deleteCompleted} className="w-full py-2 text-sm text-red-600 border border-red-200 rounded hover:bg-red-50">Clear Completed</button></div>}
                        </div>
                    </aside>
                    <main className="flex-1 flex flex-col h-full w-full relative">
                        <header className="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-4 lg:px-8 shadow-sm z-10">
                            <div className="flex items-center">
                                <button onClick={() => setIsMobileMenuOpen(true)} className="lg:hidden mr-4 text-gray-600"><Icons.Menu /></button>
                                <h2 className="text-xl font-bold text-gray-800 capitalize">{view === 'weekly_review' ? 'Weekly Review' : view === 'next' ? 'Next Actions' : view === 'guide' ? 'GTD Guide' : view}</h2>
                            </div>
                            <div className="flex items-center gap-3">
                                {saveStatus === 'saving' && <span className="text-xs flex items-center gap-1.5 text-blue-500"><span className="w-3 h-3 border-2 border-blue-300 border-t-blue-600 rounded-full spinner"></span> Saving...</span>}
                                {saveStatus === 'unsaved' && <span className="text-xs flex items-center gap-1.5 text-orange-400"><span className="w-2 h-2 rounded-full bg-orange-400"></span> Unsaved</span>}
                                {saveStatus === 'error' && <span className="text-xs flex items-center gap-1.5 text-red-500" title="Save failed after retries. Changes will retry on next edit."><span className="w-2 h-2 rounded-full bg-red-500"></span> Save failed</span>}
                                {saveStatus === 'saved' && <span className="text-xs text-green-500 flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-400"></span></span>}
                                {user.photoURL && <img src={user.photoURL} alt="" className="w-8 h-8 rounded-full cursor-pointer" referrerPolicy="no-referrer" onClick={() => setView('settings')} title={user.displayName} />}
                            </div>
                        </header>
                        <div className="flex-1 overflow-y-auto p-4 lg:p-8 relative">
                            {(view === 'inbox' || view === 'next') && <div className="mb-8 flex gap-2">
                                <form onSubmit={handleAddTask} className="flex-1 relative"><input type="text" value={newTask} onChange={(e) => setNewTask(e.target.value)} placeholder={inboxVoiceState === 'recording' ? 'Listening...' : inboxVoiceState === 'loading' ? `Loading voice model (${inboxLoadProgress}%)...` : inboxVoiceState === 'transcribing' ? 'Transcribing...' : view === 'inbox' ? "What's on your mind?" : "Add a next action..."} className={`w-full p-4 pl-5 pr-12 rounded-lg shadow-sm border ${inboxVoiceState === 'recording' ? 'border-red-300 bg-red-50' : 'border-gray-200'} focus:shadow-md focus:border-blue-400 outline-none text-lg transition-shadow`} /><button type="submit" className="absolute right-3 top-1/2 transform -translate-y-1/2 bg-blue-600 text-white p-1.5 rounded-md hover:bg-blue-700 transition-colors"><Icons.Plus /></button></form>
                                <button onClick={inboxVoiceState === 'recording' ? stopInboxRecording : inboxVoiceState === 'idle' ? startInboxRecording : undefined} disabled={inboxVoiceState === 'loading' || inboxVoiceState === 'transcribing'} className={`px-4 rounded-lg shadow-sm border transition-all flex items-center gap-2 bg-white ${inboxVoiceState === 'recording' ? 'border-red-300 text-red-600 recording-pulse' : inboxVoiceState === 'loading' || inboxVoiceState === 'transcribing' ? 'border-gray-200 text-gray-400' : 'border-gray-200 text-gray-600 hover:shadow-md hover:border-blue-300'}`} title="Voice capture">{inboxVoiceState === 'recording' ? <Icons.Stop /> : inboxVoiceState === 'loading' || inboxVoiceState === 'transcribing' ? <span className="w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-full spinner"></span> : <Icons.Microphone />}</button>
                                {view === 'inbox' && <button onClick={() => setIsBrainDumpOpen(true)} className="px-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-purple-300 transition-all flex items-center gap-2 text-purple-600 bg-white" title="Brain Dump"><Icons.BrainDump /><span className="hidden sm:inline text-sm font-medium">Dump</span></button>}
                            </div>}
                            {view === 'settings' ? <SettingsView contexts={contexts} setContexts={setContexts} delegates={delegates} setDelegates={setDelegates} apiKey={apiKey} setApiKey={setApiKey} user={user} onLogout={handleLogout} /> :
                             view === 'guide' ? <GTDGuideView apiKey={apiKey} setView={setView} /> :
                             view === 'dashboard' ? <DashboardView tasks={tasks} onCheck={markDone} onClick={setProcessingTask} setView={setView} /> :
                             view === 'weekly_review' ? <WeeklyReview tasks={tasks} onCheck={markDone} onClick={setProcessingTask} /> :
                             view === 'projects' ? renderProjectView() :
                             view === 'calendar' ? <CalendarView tasks={tasks} onCheck={markDone} onClick={setProcessingTask} /> :
                             <div className="space-y-2 pb-20">{filteredTasks.length === 0 ? <div className="text-center text-gray-400 mt-20 flex flex-col items-center"><div className="opacity-20 mb-4 scale-150">{view === 'inbox' ? <Icons.Inbox /> : <Icons.Check />}</div><p>No items in {view}</p></div> : filteredTasks.map(task => <TaskItem key={task.id} task={task} onCheck={markDone} onClick={setProcessingTask} />)}</div>}
                        </div>
                    </main>
                    <ProcessModal task={processingTask} isOpen={!!processingTask} onClose={() => setProcessingTask(null)} onUpdate={updateTask} onAddSubtasks={addMultipleTasks} contexts={contexts} delegates={delegates} apiKey={apiKey} />
                    <BrainDumpModal isOpen={isBrainDumpOpen} onClose={() => setIsBrainDumpOpen(false)} onAddTasks={addBrainDumpTasks} contexts={contexts} apiKey={apiKey} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><FirebaseProvider><App /></FirebaseProvider></ErrorBoundary>);
    </script>
</body>
</html>
